# cloudlab-caddy.toml - Production Caddy Configuration
# Generated to match existing Caddyfile configuration

#═══════════════════════════════════════════════════════════════════════════════
# SERVICE CONFIGURATION
#═══════════════════════════════════════════════════════════════════════════════

[service]
user = "caddy"
uid = 1100
subuid_start = 100000

[paths]
data_dir = "/srv/caddy"

#═══════════════════════════════════════════════════════════════════════════════
# CONTAINER CONFIGURATION
#═══════════════════════════════════════════════════════════════════════════════

[container]
name = "caddy"
image = "docker.io/library/caddy:2-alpine"
network_mode = "pasta"

# Unit options
documentation = "https://caddyserver.com/docs/"
requires = ["caddy-data-volume.service", "caddy-config-volume.service"]
start_limit_burst = 5
start_limit_interval_sec = 300

# Service options
restart = "on-failure"
restart_sec = 10
timeout_start_sec = 120
timeout_stop_sec = 30

# Security options
no_new_privileges = true
read_only_rootfs = true
log_driver = "journald"

[[container.ports]]
host = 80
container = 80

[[container.ports]]
host = 443
container = 443

[[container.ports]]
host = 443
container = 443
protocol = "udp"

# Custom volumes
[[container.volumes]]
host = "/srv/caddy/Caddyfile"
container = "/etc/caddy/Caddyfile"
options = "ro"

[[container.volumes]]
host = "caddy-data.volume"
container = "/data"

[[container.volumes]]
host = "caddy-config.volume"
container = "/config"

[[container.volumes]]
host = "/srv/caddy/webfiles"
container = "/webfiles"
options = "ro"

# Health check
[container.health]
cmd = "wget --no-verbose --tries=1 --spider http://localhost:80/ || exit 1"
interval = "30s"
retries = 3
start_period = "10s"
on_failure = "kill"

#═══════════════════════════════════════════════════════════════════════════════
# CADDYFILE CONFIGURATION
#═══════════════════════════════════════════════════════════════════════════════

[caddyfile]

[caddyfile.global]
email = "letsencrypt@qrs.lol"
# acme_ca = "https://acme-staging-v02.api.letsencrypt.org/directory"

#───────────────────────────────────────────────────────────────────────────────
# Snippets
#───────────────────────────────────────────────────────────────────────────────

[[caddyfile.snippets]]
name = "security_headers"
raw = """
header {
	Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
	X-Frame-Options "SAMEORIGIN"
	X-Content-Type-Options "nosniff"
	Referrer-Policy "strict-origin-when-cross-origin"
	Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()"
	-Server
	-X-Powered-By
}
"""

#───────────────────────────────────────────────────────────────────────────────
# Local Services (this host)
#───────────────────────────────────────────────────────────────────────────────

[[caddyfile.sites]]
addresses = ["photos.jenkinsameri.com"]
[[caddyfile.sites.directives]]
directive = "encode"
args = ["zstd", "gzip"]
[[caddyfile.sites.directives]]
directive = "import"
args = ["security_headers"]
[[caddyfile.sites.directives]]
directive = "reverse_proxy"
args = ["127.0.0.1:2283"]

[[caddyfile.sites]]
addresses = ["budget.jenkinsameri.com"]
[[caddyfile.sites.directives]]
directive = "encode"
args = ["zstd", "gzip"]
[[caddyfile.sites.directives]]
directive = "import"
args = ["security_headers"]
[[caddyfile.sites.directives]]
directive = "reverse_proxy"
args = ["127.0.0.1:5006"]

#───────────────────────────────────────────────────────────────────────────────
# Remote Services
#───────────────────────────────────────────────────────────────────────────────

[[caddyfile.sites]]
addresses = ["speedtest.ameri.me"]
[[caddyfile.sites.directives]]
directive = "import"
args = ["security_headers"]
[[caddyfile.sites.directives]]
directive = "reverse_proxy"
args = ["librespeed.home.ameri.me:8080"]

[[caddyfile.sites]]
addresses = ["plex.ameri.me"]
[[caddyfile.sites.directives]]
directive = "reverse_proxy"
args = ["plex.home.ameri.me:32400"]

[[caddyfile.sites]]
addresses = ["audiobooks.jenkinsameri.com"]
[[caddyfile.sites.directives]]
directive = "encode"
args = ["zstd", "gzip"]
[[caddyfile.sites.directives]]
directive = "import"
args = ["security_headers"]
[[caddyfile.sites.directives]]
directive = "reverse_proxy"
args = ["audiobookshelf.home.ameri.me:8080"]

[[caddyfile.sites]]
addresses = ["blog.ameri.coffee"]
[[caddyfile.sites.directives]]
directive = "encode"
args = ["zstd", "gzip"]
[[caddyfile.sites.directives]]
directive = "import"
args = ["security_headers"]
[[caddyfile.sites.directives]]
directive = "handle"
matcher = "/robots.txt"
[[caddyfile.sites.directives.block]]
directive = "root"
args = ["*", "/webfiles"]
[[caddyfile.sites.directives.block]]
directive = "file_server"
[[caddyfile.sites.directives]]
directive = "reverse_proxy"
args = ["writefreely.home.ameri.me:8080"]

[[caddyfile.sites]]
addresses = ["notes.ameri.coffee"]
[[caddyfile.sites.directives]]
directive = "encode"
args = ["zstd", "gzip"]
[[caddyfile.sites.directives]]
directive = "import"
args = ["security_headers"]
[[caddyfile.sites.directives]]
directive = "handle"
matcher = "/robots.txt"
[[caddyfile.sites.directives.block]]
directive = "root"
args = ["*", "/webfiles"]
[[caddyfile.sites.directives.block]]
directive = "file_server"
[[caddyfile.sites.directives]]
directive = "reverse_proxy"
args = ["memos.home.ameri.me:8080"]

[[caddyfile.sites]]
addresses = ["files.ameri.coffee"]
# Using raw block for complex matcher with 'file' directive
raw = """
import security_headers
encode zstd gzip
root * /webfiles/americoffee
@static {
	file
	path *.ico *.css *.js *.gif *.jpg *.jpeg *.png *.svg *.woff *.woff2 *.html
}
handle @static {
	header Cache-Control "public, max-age=2592000"
}
file_server {
	precompressed zstd gzip
}
"""
