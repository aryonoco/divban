# SPDX-License-Identifier: 0BSD
# SPDX-FileCopyrightText: 2026 Aryan Ameri <info@ameri.me>
#
# divban-caddy.toml - Caddy reverse proxy configuration

[paths]
dataDir = "/srv/divban-caddy"

# ─────────────────────────────────────────────────────────────────────────────
# Container Configuration
# ─────────────────────────────────────────────────────────────────────────────

[container]
image = "docker.io/library/caddy:2-alpine"
autoUpdate = "registry"

[[container.ports]]
host = 80
container = 80
protocol = "tcp"

[[container.ports]]
host = 443
container = 443
protocol = "tcp"

[[container.ports]]
host = 443
container = 443
protocol = "udp"

# ─────────────────────────────────────────────────────────────────────────────
# Network Configuration
# ─────────────────────────────────────────────────────────────────────────────

[network]
# Map host loopback to this private IP inside the container.
# Allows Caddy to reach services bound to 127.0.0.1 on the host.
# Must be RFC 1918 IPv4 (10.x.x.x, 172.16-31.x.x, 192.168.x.x) or RFC 4193 IPv6.
mapHostLoopback = "172.31.255.254"

# ─────────────────────────────────────────────────────────────────────────────
# Caddyfile Configuration
# ─────────────────────────────────────────────────────────────────────────────

[caddyfile.global]
email = "admin@example.com"
# Staging CA (safe for testing, avoids rate limits)
acmeCA = "https://acme-staging-v02.api.letsencrypt.org/directory"
# Production CA (uncomment when ready):
# acmeCA = "https://acme.letsencrypt.org/directory"

# ─────────────────────────────────────────────────────────────────────────────
# Snippets
# ─────────────────────────────────────────────────────────────────────────────

[[caddyfile.snippets]]
name = "common_headers"
[[caddyfile.snippets.directives]]
name = "header"
args = ["X-Frame-Options", "SAMEORIGIN"]
[[caddyfile.snippets.directives]]
name = "header"
args = ["X-Content-Type-Options", "nosniff"]

# ─────────────────────────────────────────────────────────────────────────────
# Sites
# ─────────────────────────────────────────────────────────────────────────────

# Immich
# Use mapped loopback IP to reach services bound to host's 127.0.0.1
[[caddyfile.sites]]
addresses = ["photos.example.com"]
[[caddyfile.sites.directives]]
name = "import"
args = ["common_headers"]
[[caddyfile.sites.directives]]
name = "reverse_proxy"
args = ["172.31.255.254:2283"]

# Actual Budget
# Use mapped loopback IP to reach services bound to host's 127.0.0.1
[[caddyfile.sites]]
addresses = ["budget.example.com"]
[[caddyfile.sites.directives]]
name = "import"
args = ["common_headers"]
[[caddyfile.sites.directives]]
name = "reverse_proxy"
args = ["172.31.255.254:5006"]
