// SPDX-License-Identifier: MPL-2.0
// SPDX-FileCopyrightText: 2026 Aryan Ameri <info@ameri.me>
//
// This Source Code Form is subject to the terms of the Mozilla Public
// License, v. 2.0. If a copy of the MPL was not distributed with this
// file, You can obtain one at https://mozilla.org/MPL/2.0/.

/**
 * Entry point for complete Caddyfile generation. Assembles global options,
 * snippets, and site blocks from configuration, delegating to specialized
 * modules for each section.
 */

import { Option, pipe } from "effect";
import { nonEmpty } from "../../../lib/option-helpers";
import type { CaddyfileConfig } from "../schema";
import { Caddy, type CaddyOp, caddyfile } from "./format";
import { globalOps, hasGlobalOptions } from "./global";
import { sitesOps } from "./sites";
import { snippetsOps } from "./snippets";

export const generateCaddyfile = (config: CaddyfileConfig): string => {
  const globalOpt = pipe(Option.fromNullable(config.global), Option.filter(hasGlobalOptions));
  const snippetsOpt = nonEmpty(config.snippets);

  return caddyfile(
    Caddy.comment("Caddyfile generated by divban"),
    Caddy.comment(`Generated at: ${new Date().toISOString()}`),
    Caddy.comment("DO NOT EDIT MANUALLY"),
    Caddy.blank,

    pipe(
      globalOpt,
      Option.match({
        onNone: (): CaddyOp => Caddy.id,
        onSome: (global): CaddyOp =>
          Caddy.seq(Caddy.comment("Global options"), globalOps(global), Caddy.blank),
      })
    ),

    pipe(
      snippetsOpt,
      Option.match({
        onNone: (): CaddyOp => Caddy.id,
        onSome: (snippets): CaddyOp =>
          Caddy.seq(Caddy.comment("Snippets"), snippetsOps(snippets), Caddy.blank),
      })
    ),

    Caddy.comment("Sites"),
    sitesOps(config.sites)
  );
};

export {
  escapeValue,
  indent,
  joinArgs,
  openBlock,
  formatLine,
  Caddy,
  caddyfile,
  type CaddyOp,
} from "./format";

export { generateGlobalOptions, globalOps, hasGlobalOptions } from "./global";

export {
  generateSnippet,
  generateSnippets,
  snippetOps,
  snippetsOps,
  importSnippet,
} from "./snippets";

export {
  generateNamedMatcher,
  generateNamedMatchers,
  matcherOps,
  matchersOps,
  matcherRef,
  isEmptyMatcher,
} from "./matchers";

export {
  renderDirective,
  renderDirectives,
  directiveOp,
  directivesOps,
  Directives,
} from "./directives";

export {
  generateRoute,
  generateSite,
  generateSites,
  routeOps,
  siteOps,
  sitesOps,
  Sites,
} from "./sites";
