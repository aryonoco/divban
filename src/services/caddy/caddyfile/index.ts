// SPDX-License-Identifier: MPL-2.0
// SPDX-FileCopyrightText: 2026 Aryan Ameri <info@ameri.me>
//
// This Source Code Form is subject to the terms of the Mozilla Public
// License, v. 2.0. If a copy of the MPL was not distributed with this
// file, You can obtain one at https://mozilla.org/MPL/2.0/.

/**
 * Complete Caddyfile generation.
 */

import { Option, pipe } from "effect";
import { nonEmpty } from "../../../lib/option-helpers";
import type { CaddyfileConfig } from "../schema";
import { createBuilder } from "./format";
import { generateGlobalOptions, hasGlobalOptions } from "./global";
import { generateSites } from "./sites";
import { generateSnippets } from "./snippets";

/**
 * Generate a complete Caddyfile from configuration.
 */
export const generateCaddyfile = (config: CaddyfileConfig): string => {
  const builder = createBuilder();

  // Header comment
  builder.comment("Caddyfile generated by divban");
  builder.comment(`Generated at: ${new Date().toISOString()}`);
  builder.comment("DO NOT EDIT MANUALLY");
  builder.blank();

  // Global options (if any)
  const globalOpt = pipe(Option.fromNullable(config.global), Option.filter(hasGlobalOptions));
  if (Option.isSome(globalOpt)) {
    builder.comment("Global options");
    builder.raw(generateGlobalOptions(globalOpt.value).trim());
    builder.blank();
  }

  // Snippets (if any)
  const snippetsOpt = nonEmpty(config.snippets);
  if (Option.isSome(snippetsOpt)) {
    builder.comment("Snippets");
    builder.raw(generateSnippets(snippetsOpt.value).trim());
    builder.blank();
  }

  // Sites
  builder.comment("Sites");
  builder.raw(generateSites(config.sites).trim());

  return builder.build();
};

// Re-export all sub-modules

// format.ts
export {
  escapeValue,
  indent,
  joinArgs,
  openBlock,
  formatLine,
  CaddyfileBuilder,
  createBuilder,
} from "./format";

// global.ts
export { generateGlobalOptions, hasGlobalOptions } from "./global";

// snippets.ts
export { generateSnippet, generateSnippets, importSnippet } from "./snippets";

// matchers.ts
export {
  generateNamedMatcher,
  generateNamedMatchers,
  matcherRef,
  isEmptyMatcher,
} from "./matchers";

// directives.ts
export { renderDirective, renderDirectives, Directives } from "./directives";

// sites.ts
export { generateRoute, generateSite, generateSites, Sites } from "./sites";
